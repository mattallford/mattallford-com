name: Build Hugo Site

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  HUGO_VERSION: "0.79.1"
  # OCTOPUS_URL: ${{ secrets.OCTOPUS_URL }}
  # OCTOPUS_API_KEY: ${{ secrets.OCTOPUS_API_KEY }}
  OCTOPUS_SPACE: "Default"

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
    steps:
      - name: Login to Octopus
        id: login_to_octopus
        uses: OctopusDeploy/login@v1
        with:
          server: https://mattallford.octopus.app
          service_account_id: 070b764c-e9af-41ca-8703-7aea43b15af5

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup GitVersion
        uses: gittools/actions/gitversion/setup@v3.2.0
        with:
          versionSpec: "6.x"

      - name: Calculate version
        id: calculate_version
        uses: gittools/actions/gitversion/execute@v3.2.0

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: ${{ env.HUGO_VERSION }}

      - name: Build site
        run: hugo --minify

      - name: Package site
        id: package_site
        run: |
          PACKAGE_FILE="mattallford-com-blog.${{ steps.calculate_version.outputs.semVer }}.zip"
          cd public && zip -r "../$PACKAGE_FILE" .
          echo "package_file=$PACKAGE_FILE" >> "$GITHUB_OUTPUT"
          echo "Created package: $PACKAGE_FILE"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: mattallford-com-blog
          path: ${{ steps.package_site.outputs.package_file }}
          if-no-files-found: error

      - name: Push package to Octopus Deploy ğŸ™
        id: push_package_to_octopus_deploy
        uses: OctopusDeploy/push-package-action@v4
        with:
          packages: |
            ${{ steps.package_site.outputs.package_file }}

      # - name: Push build information to Octopus Deploy ğŸ™
      #   id: push_build_information_to_octopus_deploy
      #   uses: OctopusDeploy/push-build-information-action@v4
      #   with:
      #     packages: |
      #       mattallford-com-blog
      #     version: ${{ steps.calculate_version.outputs.semVer }}
